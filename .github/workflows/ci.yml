name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Manifest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate INSTALLATION.yaml
        run: |
          version=$(yq eval '.package.version' INSTALLATION.yaml)
          if [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "✓ Valid manifest version: $version"
          else
            echo "✗ Invalid manifest version: $version"
            exit 1
          fi

      - name: Check no legacy VERSION file
        run: |
          if [[ -f VERSION ]]; then
            echo "✗ Legacy VERSION file still exists — remove it"
            exit 1
          fi
          echo "✓ No legacy VERSION file"

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint shell scripts
        run: |
          shellcheck -x install.sh || true
          shellcheck -x release.sh || true

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run wizard tests
        run: bash tests/test-wizard.sh

  release-dry-run:
    name: Release Dry Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Test release.sh dry run
        run: ./release.sh patch --dry-run
