#!/usr/bin/env bash
# Simplified build script using find and parallel execution

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

SKILLS_DIR="${REPO_ROOT}/skills"
OUTPUTS_DIR="${REPO_ROOT}/outputs"

echo "Building all agent outputs from Claude sources..."
echo ""

# Clean outputs directory
echo "Cleaning outputs directory..."
rm -rf "$OUTPUTS_DIR"/{claude,windsurf,cursor,opencode}
mkdir -p "$OUTPUTS_DIR"/{claude/skills,windsurf/workflows,cursor/commands,opencode/commands}

# Count skills
skill_count=$(find "$SKILLS_DIR" -name "SKILL.md" | wc -l | tr -d ' ')
echo "Found $skill_count skills to convert"
echo ""

# Convert each skill
skill_num=0
find "$SKILLS_DIR" -name "SKILL.md" | while read -r source_file; do
  skill_num=$((skill_num + 1))

  # Extract skill name
  skill_dir=$(dirname "$source_file")
  skill_name=$(basename "$skill_dir")

  echo "[$skill_num/$skill_count] $skill_name"

  # Define output paths
  claude_out="${OUTPUTS_DIR}/claude/skills/${skill_name}/SKILL.md"
  windsurf_out="${OUTPUTS_DIR}/windsurf/workflows/${skill_name}.md"
  cursor_out="${OUTPUTS_DIR}/cursor/commands/${skill_name}.md"
  opencode_out="${OUTPUTS_DIR}/opencode/commands/${skill_name}.md"

  # Convert to each format
  mkdir -p "$(dirname "$claude_out")"
  TMPDIR=/tmp cace convert "$source_file" -t claude -o "$claude_out" 2>/dev/null && echo -n "." || echo -n "x"
  TMPDIR=/tmp cace convert "$source_file" -t windsurf -o "$windsurf_out" 2>/dev/null && echo -n "." || echo -n "x"
  TMPDIR=/tmp cace convert "$source_file" -t cursor -o "$cursor_out" 2>/dev/null && echo -n "." || echo -n "x"
  TMPDIR=/tmp cace convert "$source_file" -t opencode -o "$opencode_out" 2>/dev/null && echo -n "." || echo -n "x"
  echo ""
done

# Update version
echo "0.4.0" > "$OUTPUTS_DIR/version.txt"

echo ""
echo "Build complete!"
echo ""
echo "Generated:"
echo "  Claude:   $(find "$OUTPUTS_DIR/claude" -name "*.md" | wc -l | tr -d ' ') files"
echo "  Windsurf: $(find "$OUTPUTS_DIR/windsurf" -name "*.md" | wc -l | tr -d ' ') files"
echo "  Cursor:   $(find "$OUTPUTS_DIR/cursor" -name "*.md" | wc -l | tr -d ' ') files"
echo "  OpenCode: $(find "$OUTPUTS_DIR/opencode" -name "*.md" | wc -l | tr -d ' ') files"
echo ""
