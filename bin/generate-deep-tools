#!/usr/bin/env bash
set -euo pipefail

# Developer-only generator for Agent Deep Toolkit artifacts.
#
# Architecture (v0.3.0):
# - Single source of truth: tools/deep-tools.json (metadata + content for all tools).
# - One template per agent:
#   - templates/windsurf/workflow-template.md
#   - templates/claude-code/skill-template.md
#   - templates/cursor/command-template.md
# - This script renders:
#   - One Windsurf workflow per tool (outputs/windsurf/workflows/deep-*.md)
#   - One Claude skill per tool (outputs/claude/skills/deep-*/SKILL.md)
#   - One Cursor command per tool (outputs/cursor/commands/deep-*.md)
# - All three agents get identical 1:1 coverage of all deep-* tools.

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TOOLS_JSON="$ROOT_DIR/tools/deep-tools.json"
WINDSURF_TEMPLATE="$ROOT_DIR/templates/windsurf/workflow-template.md"
CLAUDE_SKILL_TEMPLATE="$ROOT_DIR/templates/claude-code/skill-template.md"
CURSOR_TEMPLATE="$ROOT_DIR/templates/cursor/command-template.md"
OUTPUTS_ROOT="$ROOT_DIR/outputs"
WINDSURF_OUT_DIR="$OUTPUTS_ROOT/windsurf/workflows"
CLAUDE_OUT_ROOT="$OUTPUTS_ROOT/claude/skills"
CURSOR_OUT_DIR="$OUTPUTS_ROOT/cursor/commands"
VERSION_FILE="$ROOT_DIR/VERSION"

if [ ! -f "$TOOLS_JSON" ]; then
  echo "[error] tools JSON not found at $TOOLS_JSON" >&2
  exit 1
fi

if [ ! -f "$VERSION_FILE" ]; then
  echo "[error] VERSION file not found at $VERSION_FILE" >&2
  exit 1
fi

TOOLKIT_VERSION="$(cat "$VERSION_FILE" | tr -d '[:space:]')"
echo "[info] generating version $TOOLKIT_VERSION from $TOOLS_JSON"

python3 - "$TOOLS_JSON" "$WINDSURF_TEMPLATE" "$CLAUDE_SKILL_TEMPLATE" "$CURSOR_TEMPLATE" "$WINDSURF_OUT_DIR" "$CLAUDE_OUT_ROOT" "$CURSOR_OUT_DIR" <<'PY'
import json
import shutil
import sys
from pathlib import Path

cfg_path, windsurf_tpl_path, skill_tpl_path, cursor_tpl_path, windsurf_out_dir, claude_out_root, cursor_out_dir = sys.argv[1:]

cfg_file = Path(cfg_path)
if not cfg_file.is_file():
    raise SystemExit(f"[error] tools JSON not found at {cfg_file}")

with cfg_file.open("r", encoding="utf-8") as f:
    cfg = json.load(f)

windsurf_tpl_file = Path(windsurf_tpl_path)
skill_tpl_file = Path(skill_tpl_path)
cursor_tpl_file = Path(cursor_tpl_path)

if not windsurf_tpl_file.is_file():
    raise SystemExit(f"[error] Windsurf template not found at {windsurf_tpl_file}")
if not skill_tpl_file.is_file():
    raise SystemExit(f"[error] Claude skill template not found at {skill_tpl_file}")
if not cursor_tpl_file.is_file():
    raise SystemExit(f"[error] Cursor template not found at {cursor_tpl_file}")

windsurf_template = windsurf_tpl_file.read_text(encoding="utf-8")
skill_template = skill_tpl_file.read_text(encoding="utf-8")
cursor_template = cursor_tpl_file.read_text(encoding="utf-8")

windsurf_out = Path(windsurf_out_dir)
claude_root = Path(claude_out_root)
cursor_out = Path(cursor_out_dir)

shutil.rmtree(windsurf_out, ignore_errors=True)
shutil.rmtree(claude_root, ignore_errors=True)
shutil.rmtree(cursor_out, ignore_errors=True)
windsurf_out.mkdir(parents=True, exist_ok=True)
claude_root.mkdir(parents=True, exist_ok=True)
cursor_out.mkdir(parents=True, exist_ok=True)

def render_windsurf_workflow(tool: dict) -> str:
    """Render a Windsurf workflow from a tool definition."""
    meta = tool.get("windsurf") or {}
    body = tool.get("body", "").lstrip("\n")
    text = windsurf_template
    text = text.replace("{{ID}}", tool.get("id", ""))
    text = text.replace("{{DESCRIPTION}}", meta.get("description", ""))
    mode = meta.get("autoExecutionMode")
    text = text.replace("{{AUTO_EXECUTION_MODE}}", "" if mode is None else str(mode))
    text = text.replace("{{BODY}}", body)
    return text

def render_claude_skill(tool: dict) -> str:
    """Render a Claude skill from a tool definition.

    Each tool becomes its own skill (1:1 with Windsurf workflows).
    The skill body is the same workflow content used for Windsurf.
    """
    tool_id = tool.get("id", "")
    body = tool.get("body", "").lstrip("\n")

    # Use claude metadata if present, otherwise derive from windsurf metadata
    claude_meta = tool.get("claude") or {}
    windsurf_meta = tool.get("windsurf") or {}

    name = claude_meta.get("name") or tool_id
    description = claude_meta.get("description") or windsurf_meta.get("description", "")

    # Default: user-invocable, model cannot auto-invoke (safe for workflows with side effects)
    disable_model = claude_meta.get("disableModelInvocation", True)
    user_invocable = claude_meta.get("userInvocable", True)

    text = skill_template
    text = text.replace("{{ID}}", tool_id)
    text = text.replace("{{NAME}}", name)
    text = text.replace("{{DESCRIPTION}}", description)
    text = text.replace("{{DISABLE_MODEL_INVOCATION}}", str(disable_model).lower())
    text = text.replace("{{USER_INVOCABLE}}", str(user_invocable).lower())
    text = text.replace("{{BODY}}", body)
    return text

def render_cursor_command(tool: dict) -> str:
    """Render a Cursor command from a tool definition.

    Cursor commands are plain markdown files in .cursor/commands/.
    No frontmatter needed - just the workflow body content.
    """
    body = tool.get("body", "").lstrip("\n")
    text = cursor_template
    text = text.replace("{{BODY}}", body)
    return text

tools = cfg.get("tools", [])

print(f"[info] generating Windsurf workflows into {windsurf_out}")
for tool in tools:
    tool_id = tool.get("id")
    if not tool_id:
        continue
    dest = windsurf_out / f"{tool_id}.md"
    dest.write_text(render_windsurf_workflow(tool), encoding="utf-8")
    print(f"[ok] wrote Windsurf workflow {dest.name}")

print(f"[info] generating Claude skills into {claude_root}")
for tool in tools:
    tool_id = tool.get("id")
    if not tool_id:
        continue
    skill_dir = claude_root / tool_id
    skill_dir.mkdir(parents=True, exist_ok=True)
    skill_md = skill_dir / "SKILL.md"
    skill_md.write_text(render_claude_skill(tool), encoding="utf-8")
    print(f"[ok] wrote Claude skill {tool_id}")

print(f"[info] generating Cursor commands into {cursor_out}")
for tool in tools:
    tool_id = tool.get("id")
    if not tool_id:
        continue
    dest = cursor_out / f"{tool_id}.md"
    dest.write_text(render_cursor_command(tool), encoding="utf-8")
    print(f"[ok] wrote Cursor command {dest.name}")
PY

# Write version.txt to outputs root
echo "$TOOLKIT_VERSION" > "$OUTPUTS_ROOT/version.txt"
echo "[ok] wrote $OUTPUTS_ROOT/version.txt ($TOOLKIT_VERSION)"

echo "[info] deep-tools generation complete."

